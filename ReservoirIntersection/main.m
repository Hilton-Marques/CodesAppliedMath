clc;
clear;
close all;

addpath("ConvexCell\","Drawer\","GJK\","QuickHull\","ReservoirIntersection\","CellIntersection\");

id = ijk(67,40,1);
id2 = ijk(5,23,19);
%testeRegularGrid();
%addpath("CellIntersection\");
%drawer = Drawer(); % drawCells
% n = 1000;
 %model_A = readmatrix("model-182.109.txt");
 
 %bb = BBIntersection(model_A,ids_A);
 %[cells,bins_ids] = bb.FindGroup(this.m_model_A(i,:))
 %model_A = model_A(1:end,2:end);
 %ReservoirIntersection(model_A,model_A,1,ids_A,ids_A);
% %model_B = readmatrix("model-2511.17.txt");
% model_B = readmatrix("model-2473.5.txt");
% ids_n = 1:length(model_B);
% ids_B = model_B(:,1);
% model_B = model_B(1:end,2:end);
% drawer = Drawer();
%drawer.showModel(model_A,drawer.m_red);
%drawer.showModel(model_B,drawer.m_blue);
%ReservoirIntersection(model_B,model_B,1,ids_B,ids_B);
%ReservoirIntersection(model_B,model_B,1,ids_B,ids_B);

%view(-99,85);
%drawer.showModel(model_B,drawer.m_blue);


% cell 572 and 53067
pts_572 = [3151.57812 -2008.25000 -3190.63989 ; ...
3100.35938 -1921.25000 -3192.01001 ; ...
3064.98438 -2062.25000 -3172.59009 ; ...
3013.79688 -1975.25000 -3175.23999 ; ...
3151.57812 -2008.25000 -3197.63989 ; ...
3100.35938 -1921.25000 -3199.01001 ; ...
3064.98438 -2062.25000 -3179.59009 ; ...
3013.79688 -1975.25000 -3182.23999 ];

pts_53067 = [3085.82812  -1954.75000  -3179.82007 ; ...
2997.82812  -1904.75000  -3174.13989 ; ...
3037.82812  -2044.75000  -3179.85010 ; ...
2949.82812  -1994.75000  -3173.11011 ; ...
3085.82812  -1954.75000  -3179.82007 ; ...
2997.82812  -1904.75000  -3174.13989 ; ...
3037.82812  -2044.75000  -3181.20996 ; ...
2949.82812  -1994.75000  -3174.10010 ];

%cell 146 and 4132
pts_146 = [3007.82812  -805.250000  -3230.40991 ; ...
2957.48438  -718.750000  -3223.41992 ; ...
2921.26562  -859.250000  -3229.18994 ; ...
2870.92188  -772.750000  -3221.79004 ; ...
3007.82812  -805.250000  -3237.40991 ; ...
2957.48438  -718.750000  -3230.41992 ; ...
2921.26562  -859.250000  -3236.18994 ; ...
2870.92188  -772.750000  -3228.79004 ];

pts_4132 = [2999.82812 -654.750000 -3234.76001 ; ...
2911.82812 -604.750000 -3226.10010 ; ...
2951.82812 -744.750000 -3220.13989 ; ...
2863.82812 -694.750000 -3213.43994 ; ...
2999.82812 -654.750000 -3241.76001 ; ...
2911.82812 -604.750000 -3233.10010 ; ...
2951.82812 -744.750000 -3227.13989 ; ...
2863.82812 -694.750000 -3220.43994 ];

pts_1156 = [[-432.500000 , 2225.00000 , -3158.59009 ]; ...
[-519.500000 , 2275.00000 , -3170.91992 ]; ...
[-480.500000 , 2145.00000 , -3163.04004 ]; ...
[-567.500000 , 2185.00000 , -3178.47998 ]; ...
[-432.500000 , 2225.00000 , -3158.59009 ]; ...
[-519.500000 , 2275.00000 , -3170.91992 ]; ...
[-480.500000 , 2145.00000 , -3166.83008 ]; ...
[-567.500000 , 2185.00000 , -3180.59009 ]];

pts_15382 = [[ -344.500000 2185.00000 -3147.56006] ; ...
[ -432.500000 2225.00000 -3158.59009] ; ...
[ -392.500000 2095.00000 -3152.87012] ; ...
[ -480.500000 2145.00000 -3166.83008] ; ...
[ -344.500000 2185.00000 -3147.56006] ; ...
[ -432.500000 2225.00000 -3158.59009] ; ...
[ -392.500000 2095.00000 -3154.64990] ; ...
[ -480.500000 2145.00000 -3166.83008]];

pts_1 = [[-1948.50000 , 2375.00000 , -3209.43994 ]; ...
[-2036.50000 , 2425.00000 , -3202.65991 ]; ...
[-1996.50000 , 2285.00000 , -3185.59009 ]; ...
[-2084.50000 , 2335.00000 , -3191.12012 ]; ...
[-1948.50000 , 2375.00000 , -3210.25000 ]; ...
[-2036.50000 , 2425.00000 , -3202.65991 ]; ...
[-1996.50000 , 2285.00000 , -3185.59009 ]; ...
[-2084.50000 , 2335.00000 , -3191.12012 ]];

pts_2 = [[-1948.50000 , 2375.00000 , -3202.43994] ; ...
[-2036.50000 , 2425.00000 , -3202.65991] ; ...
[-1996.50000 , 2285.00000 , -3185.59009] ; ...
[-2084.50000 , 2335.00000 , -3189.82007] ; ...
[-1948.50000 , 2375.00000 , -3209.43994] ; ...
[-2036.50000 , 2425.00000 , -3202.65991] ; ...
[-1996.50000 , 2285.00000 , -3185.59009] ; ...
[-2084.50000 , 2335.00000 , -3191.12012]];

pts_4666 = [-500.000000 , -16300.0000 , -6137.10986  ; ...
-400.000000 , -16300.0000 , -6138.54980  ; ...
-500.000000 , -16200.0000 , -6134.25000  ; ...
-400.000000 , -16200.0000 , -6135.04980  ; ...
-500.000000 , -16300.0000 , -6143.91992  ; ...
-400.000000 , -16300.0000 , -6145.31006  ; ...
-500.000000 , -16200.0000 , -6141.04980  ; ...
-400.000000 , -16200.0000 , -6141.79980  ];

pts_4 = [-600.000000 , -16400.0000 , -6138.02002  ; ...
-499.999969 , -16400.0000 , -6139.50000  ; ...
-600.000000 , -16300.0000 , -6136.12988  ; ...
-499.999969 , -16300.0000 , -6137.10986  ; ...
-600.000000 , -16400.0000 , -6144.91992  ; ...
-499.999969 , -16400.0000 , -6146.35010  ; ...
-600.000000 , -16300.0000 , -6142.99023  ; ...
-499.999969 , -16300.0000 , -6143.91992  ];

pts_4665 = [-600.000000  , -16300.0000 , -6136.12988 ; ...
-499.999969  , -16300.0000 , -6137.10986 ; ...
-600.000000  , -16200.0000 , -6133.83984 ; ...
-499.999969  , -16200.0000 , -6134.25000 ; ...
-600.000000  , -16300.0000 , -6142.99023 ; ...
-499.999969  , -16300.0000 , -6143.91992 ; ...
-600.000000  , -16200.0000 , -6140.68994 ; ...
-499.999969  , -16200.0000 , -6141.04980 ];
pts_226 = [2763.48438 -606.750000 -3212.27002 ; ...
2713.14062 -519.750000 -3205.57007 ; ...
2681.92188 -651.750000 -3196.41992 ; ...
2626.57812 -573.750000 -3183.00000 ; ...
2763.48438 -606.750000 -3219.27002 ; ...
2713.14062 -519.750000 -3212.57007 ; ...
2681.92188 -651.750000 -3203.41992 ; ...
2626.57812 -573.750000 -3190.00000 ];

pts_478 = [2775.82812 , -644.750000 , -3199.65991 ; ...
2688.82812 , -594.750000 , -3192.17993 ; ...
2727.82812 , -734.750000 , -3191.29004 ; ...
2640.82812 , -684.750000 , -3180.87988 ; ...
2775.82812 , -644.750000 , -3206.65991 ; ...
2688.82812 , -594.750000 , -3199.17993 ; ...
2727.82812 , -734.750000 , -3198.29004 ; ...
2640.82812 , -684.750000 , -3187.87988 ];

pts_7864 = [2736.82812 -514.750000 -3212.38989 ; ...
2648.82812 -464.750000 -3203.25000 ; ...
2688.82812 -594.750000 -3206.17993 ; ...
2600.82812 -554.750000 -3194.87988 ; ...
2736.82812 -514.750000 -3219.38989 ; ...
2648.82812 -464.750000 -3210.25000 ; ...
2688.82812 -594.750000 -3213.17993 ; ...
2600.82812 -554.750000 -3201.87988 ];

pts_A_vis = [[-4091.9497070312500	,-10830.208007812500 ,-5167.9902343750000 ] ; ...
		[-4220.6323242187500	,-10754.779296875000 ,-5169.0200195312500 ] ; ...
		[-4160.5107421875000	,-10991.201171875000 ,-5166.9501953125000 ] ; ...
		[-4291.5029296875000	,-10915.354492187500 ,-5167.8198242187500 ] ; ...
		[-4087.8466796875000	,-10831.980468750000 ,-5177.5698242187500 ] ; ...
		[-4216.7065429687500	,-10756.545898437500 ,-5178.5400390625000 ] ; ...
		[-4156.2729492187500	,-10993.069335937500 ,-5177.0200195312500 ] ; ...
		[-4287.4233398437500	,-10917.231445312500 ,-5177.8701171875000 ] ];
pts_B_vis = [[ -4087.8068847656250	,  -10831.895507812500	 , -5177.5698242187500 ]; ...
		 [ -4216.6635742187500	,  -10756.477539062500	 , -5178.5400390625000 ]; ...
		 [ -4156.2490234375000	,  -10993.007812500000	 , -5177.0200195312500 ]; ...
		 [ -4287.3969726562500	,  -10917.183593750000	 , -5177.8701171875000 ]; ...
		 [ -4083.7045898437500	,  -10833.668945312500	 , -5187.1499023437500 ]; ...
		 [ -4212.7421875000000	,  -10758.244140625000	 , -5188.0498046875000 ]; ...
		 [ -4152.0117187500000	,  -10994.877929687500	 , -5187.0898437500000 ]; ...
		 [ -4283.3173828125000	,  -10919.060546875000	 , -5187.9199218750000 ]];

pts_A_quick = [[2782.5000000000000 , 815.0000000000 , -3217.4399414062500 ; ...	
		 2694.5000000000000 , 855.0000000000 , -3212.2700195312500 ; ...   
		 2734.5000000000000 , 725.0000000000 , -3204.8701171875000 ; ...	
		 2646.5000000000000 , 775.0000000000 , -3196.4199218750000 ; ...	
		 2782.5000000000000 , 815.0000000000 , -3224.4399414062500 ; ...	
		 2694.5000000000000 , 855.0000000000 , -3219.2700195312500 ; ...	
		 2734.5000000000000 , 725.0000000000 , -3211.8701171875000 ; ...	
		 2646.5000000000000 , 775.0000000000 , -3203.4199218750000 ]];
pts_B_quick = [[2782.5000000000000 , 815.0000000000 , -3217.4399414062500 ; ...	
		 2694.5000000000000 , 855.0000000000 , -3212.2700195312500 ; ...   
		 2734.5000000000000 , 725.0000000000 , -3204.8701171875000 ; ...	
		 2646.5000000000000 , 775.0000000000 , -3196.4199218750000 ; ...	
		 2782.5000000000000 , 815.0000000000 , -3224.4399414062500 ; ...	
		 2694.5000000000000 , 855.0000000000 , -3219.2700195312500 ; ...	
		 2734.5000000000000 , 725.0000000000 , -3211.8701171875000 ; ...	
		 2646.5000000000000 , 775.0000000000 , -3203.4199218750000 ]];

pts_A_rescue = [[-1247.0156250000000 ,	1997.7500000000000 ,	-3161.9599609375000	]; ...
		[-1335.0156250000000 ,	2037.7500000000000 ,	-3173.9001464843750	]; ...
		[-1295.0156250000000 ,	1907.7500000000000 ,	-3145.5900878906250	]; ...
		[-1383.0156250000000 ,	1957.7500000000000 ,	-3156.6699218750000	]; ...
		[-1247.0156250000000 ,	1997.7500000000000 ,	-3168.9599609375000	]; ...
		[-1335.0156250000000 ,	2037.7500000000000 ,	-3174.9050292968750	]; ...
		[-1295.0156250000000 ,	1907.7500000000000 ,	-3152.5900878906250	]; ...
		[-1383.0156250000000 ,	1957.7500000000000 ,	-3163.6699218750000	]];

pts_B_rescue = [[-1159.0156250000000	, 1947.7500000000000 ,	-3176.4396972656250]; ...	
		[-1247.0156250000000	, 1997.7500000000000 ,	-3174.6799316406250]; ...	
		[-1207.0156250000000	, 1857.7500000000000 ,	-3194.8598632812500]; ...	
		[-1295.0156250000000	, 1907.7500000000000 ,	-3189.6997070312500]; ...	
		[-1159.0156250000000	, 1947.7500000000000 ,	-3176.4396972656250]; ...	
		[-1247.0156250000000	, 1997.7500000000000 ,	-3174.6799316406250]; ...	
		[-1207.0156250000000	, 1857.7500000000000 ,	-3194.8598632812500]; ...	
		[-1295.0156250000000	, 1907.7500000000000 ,	-3189.6997070312500]];
pts_A_rescue_2 = [[2606.9843750000000	, 907.75000000000000 ,	-3282.0000000000000	];...
			[2518.9843750000000	, 957.75000000000000 ,	-3263.2600097656250	];...
			[2558.9843750000000	, 817.75000000000000 ,	-3273.8701171875000	];...
			[2470.9843750000000	, 867.75000000000000 ,	-3255.9001464843750	];...
			[2606.9843750000000	, 907.75000000000000 ,	-3282.0000000000000	];...
			[2518.9843750000000	, 957.75000000000000 ,	-3263.2600097656250	];...
			[2558.9843750000000	, 817.75000000000000 ,	-3273.8701171875000	];...
			[2470.9843750000000	, 867.75000000000000 ,	-3255.8999023437500	]];

pts_B_rescue_2 = [[2693.9843750000000	, 857.75000000000000, -3279.4648437500000];...
			[2606.9843750000000	, 907.75000000000000, -3282.0019531250000];...
			[2645.9843750000000	, 777.75000000000000, -3279.0029296875000];...
			[2558.9843750000000	, 817.75000000000000, -3267.0000000000000];...
			[2693.9843750000000	, 857.75000000000000, -3280.4697265625000];...
			[2606.9843750000000	, 907.75000000000000, -3283.0058593750000];...
			[2645.9843750000000	, 777.75000000000000, -3280.0053710937500];...
			[2558.9843750000000	, 817.75000000000000, -3271.8623046875000]];

pts_AA = [[3690.9843750000000, 	-22.250000000000000	, 	-3302.5502929687500 ];...	
		[3602.9843750000000,  27.750000000000000		, -3308.6293945312500	 ];...
		[3642.9843750000000, -112.25000000000000		, -3291.2697753906250	 ];...
		[3554.9843750000000, -62.250000000000000		, -3303.6501464843750	 ];...
		[3690.9843750000000, -22.250000000000000		, -3302.5500488281250	 ];...
		[3602.9843750000000,   27.750000000000000	, 	-3308.6298828125000 ];...	
		[3642.9843750000000, -112.25000000000000		, -3291.2700195312500	 ];...
		[3554.9843750000000, -62.250000000000000		, -3303.6499023437500	 ]];

pts_BB = [[3738.8906250000000,	64.750000000000000	, -3279.1958007812500	 ];...
			[3651.1093750000000,	112.75000000000000	, -3287.1123046875000	 ];...
			[3690.8906250000000,	-23.250000000000000, 	-3278.8623046875000 ];...	
			[3602.9843750000000,	27.750000000000000	, -3288.6699218750000	 ];...
			[3738.8906250000000,	64.750000000000000	, -3284.7275390625000	 ];...
			[3651.1093750000000,	112.75000000000000	, -3293.1762695312500	 ];...
			[3690.8906250000000,	-23.250000000000000, 	-3284.9443359375000 ];...	
			[3602.9843750000000,	27.750000000000000	, -3295.6699218750000	 ]];

pts_AA = [[1596.9843750000000	, -2182.2500000000000, -3096.2500000000000	];...
			[1508.9843750000000	, -2132.2500000000000, -3096.2302246093750	];...
			[1548.9843750000000	, -2272.2500000000000, -3094.4802246093750	];...
			[1460.9843750000000	, -2222.2500000000000, -3091.3598632812500	];...
			[1596.9843750000000	, -2182.2500000000000, -3096.2500000000000	];...
			[1508.9843750000000	, -2132.2500000000000, -3096.2299804687500	];...
			[1548.9843750000000	, -2272.2500000000000, -3094.4799804687500	];...
			[1460.9843750000000	, -2222.2500000000000, -3098.9899902343750	]];

pts_BB = [[1644.9843750000000	,	-2092.2500000000000	,		-3089.5400390625000	]; ...
			[1556.9843750000000	,	-2052.2500000000000	,		-3093.1101074218750	]; ...
			[1596.9843750000000	,	-2182.2500000000000	,		-3089.6999511718750	]; ...
			[1508.9843750000000	,	-2132.2500000000000	,		-3089.9199218750000	]; ...
			[1644.9843750000000	,	-2092.2500000000000	,		-3093.5451660156250	]; ...
			[1556.9843750000000	,	-2052.2500000000000	,		-3094.2600097656250	]; ...
			[1596.9843750000000	,	-2182.2500000000000	,		-3095.7451171875000	]; ...
			[1508.9843750000000	,	-2132.2500000000000	,		-3096.2299804687500	]];
pts_AA = [[-2892.01562 , 1067.75000 , -3142.65015 ];...
[-2980.01562 , 1117.75000 , -3149.25000 ];...
[-2940.01562 , 977.750000 , -3144.98022 ];...
[-3028.01562 , 1027.75000 , -3152.22021 ];...
[-2892.01562 , 1067.75000 , -3149.65015 ];...
[-2980.01562 , 1117.75000 , -3156.25000 ];...
[-2940.01562 , 977.750000 , -3151.98022 ];...
[-3028.01562 , 1027.75000 , -3159.22021 ]];
pts_BB = [[-2852.01562 , 937.750000 , -3168.48022 ];...
[-2940.01562 , 977.750000 , -3172.98022 ];...
[-2900.01562 , 847.750000 , -3156.82007 ];...
[-2988.01562 , 897.750000 , -3166.62012 ];...
[-2852.01562 , 937.750000 , -3168.47998 ];...
[-2940.01562 , 977.750000 , -3178.14990 ];...
[-2900.01562 , 847.750000 , -3156.82007 ];...
[-2988.01562 , 897.750000 , -3166.62012 ]];
%pts_1 = pts_572;
%pts_2 = pts_53067;
% pts_1 = pts_226;
% pts_2 = pts_7864;
pts_1 = pts_AA;
pts_2 = pts_BB;
threshold = 10;
[cell_intersection_obj,volume] = CellIntersection(pts_1,pts_2,threshold);

function testeRegularGrid()
 model = readmatrix("rescue.txt");
 ids = model(:,1);
 model = model(1:end,2:end);
 bb = BBIntersection(model,ids);
 coords = [[1220.9843750000000,	-2662.2500000000,	-2926.7399902343750	];...
			[1133.9843750000000,	-2612.2500000000,	-2926.6201171875000	];...
			[1172.9843750000000,	-2752.2500000000,	-2910.8999023437500	];...
			[1085.9843750000000,	-2702.2500000000,	-2905.3000488281250	];...
			[1220.9843750000000,	-2662.2500000000,	-2933.7399902343750	];...
			[1133.9843750000000,	-2612.2500000000,	-2933.6201171875000	];...
			[1172.9843750000000,	-2752.2500000000,	-2917.9001464843750	];...
			[1085.9843750000000,	-2702.2500000000,	-2912.3002929687500	]];
 coords = reshape(coords',24,1)';
 [cells,bins_ids] = bb.FindGroup(coords);
end
function id = ijk(i,j,k)
ni = 83;
nj = 45;
nk = 23;

i = i - 1;
j = j - 1;
k = k - 1;
id =  k*ni*nj + j*ni + i;

end